if [ $(arch | grep arm) ]; then
mkdir -p src/opt/v8
curl -sSOL http://jeroen.github.io/V8/v8-8.7.220.29.arm64_big_sur.bottle.1.tar.gz
tar xzf v8-8.7.220.29.arm64_big_sur.bottle.1.tar.gz -C src/opt/v8 --strip-components 2
rm -f v8-8.7.220.29.arm64_big_sur.bottle.1.tar.gz
BREWDIR="$PWD/src"
PKG_LIBS="-lv8"
else

export HOMEBREW_NO_ANALYTICS=1
export HOMEBREW_NO_AUTO_UPDATE=1

# Offical Homebrew no longer supports El-Capitain
UPSTREAM_ORG="autobrew"

if [ "$DISABLE_AUTOBREW" ]; then return 0; fi
AUTOBREW="$(dirname `pwd`)/.autobrew"
export HOMEBREW_TEMP="$AUTOBREW/hbtmp"
BREWDIR="$AUTOBREW/build-$PKG_BREW_NAME"
BREW="$BREWDIR/bin/brew"
rm -Rf $BREWDIR
mkdir -p $BREWDIR
echo "$(date): Auto-brewing $PKG_BREW_NAME in $BREWDIR..."
curl -fsSL https://github.com/$UPSTREAM_ORG/brew/tarball/master | tar xz --strip 1 -C $BREWDIR

# Install bottle + dependencies
export HOMEBREW_CACHE="$AUTOBREW"
$BREW deps -n $PKG_BREW_NAME 2>/dev/null
BREW_DEPS=$($BREW deps -n $PKG_BREW_NAME 2>/dev/null)
$BREW install --force-bottle $BREW_DEPS $PKG_BREW_NAME 2>&1 | perl -pe 's/Warning/Note/gi'
rm -f $BREWDIR/Cellar/$PKG_BREW_NAME/*/lib/*.dylib
rm -f $BREWDIR/opt/*/lib/*.dylib

# Needed for eg mariadb-connector-c
rm -f $BREWDIR/opt/*/lib/*/*.dylib

PKG_LIBS="-lv8_{base_without_compiler,compiler,libplatform,snapshot,libbase,libsampler,initializers,init} -ltorque_{base,generated_definitions,generated_initializers} -lchrome_zlib -lcompression_utils_portable"

# Need to expand braces for the pointer compression feature test in configure script
PKG_LIBS=$(eval echo $PKG_LIBS)

unset HOMEBREW_NO_ANALYTICS
unset HOMEBREW_NO_AUTO_UPDATE

rm -f tests/testthat/test_exception.R

# Cleanup detritus
rm -Rf $BREWDIR/Library
echo "rm -Rf $AUTOBREW" >> cleanup
chmod +x cleanup

# Not ARM
fi
