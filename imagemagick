if [ "$DISABLE_AUTOBREW" ]; then return 0; fi
export HOMEBREW_NO_ANALYTICS=1
AUTOBREW=${TMPDIR-/tmp}
BREWDIR="$AUTOBREW/build-$PKG_BREW_NAME"
BREW="$BREWDIR/bin/brew"
rm -Rf $BREWDIR
mkdir -p $BREWDIR
echo "Auto-brewing $PKG_BREW_NAME in $BREWDIR..."

# Revert to Sept 16, 2016, last day of homebrew support for OSX 10.9 Mavericks
if [ $(sw_vers -productVersion | grep -F "10.9") ]; then
  curl -fsSL https://github.com/legacybrew/brew/tarball/master | tar xz --strip 1 -C $BREWDIR
  mkdir -p $BREWDIR/Library/Taps/homebrew
  (cd $BREWDIR/Library/Taps/homebrew; git clone --depth=1 https://github.com/legacybrew/homebrew-core)
  HOMEBREW_CACHE="$AUTOBREW" $BREW install portable-ruby
else
  curl -fsSL https://github.com/Homebrew/brew/tarball/master | tar xz --strip 1 -C $BREWDIR
fi

# Build from source
HOMEBREW_CACHE="$AUTOBREW" $BREW install pkg-config 2>&1 | perl -pe 's/Warning/Note/gi'

# Disable fontconfig post install caching stuff
HOMEBREW_CACHE="$AUTOBREW" $BREW install --force-bottle freetype 2>&1 | perl -pe 's/Warning/Note/gi'
sed -i.bak '/fc-cache/d' "$BREWDIR/Library/Taps/homebrew/homebrew-core/Formula/fontconfig.rb"

# Some dependencies
HOMEBREW_CACHE="$AUTOBREW" $BREW install --force-bottle openssl fontconfig gettext glib cairo python \
  gobject-introspection gdk-pixbuf harfbuzz pango 2>&1 | perl -pe 's/Warning/Note/gi'

# Required to build GLIB stuff from source
export HOMEBREW_NO_ENV_FILTERING=1
export XDG_DATA_DIRS="$BREWDIR/share"

# Harfbuzz static lib is missing
HOMEBREW_CACHE="$AUTOBREW" $BREW reinstall harfbuzz --without-graphite2 --build-bottle

# No runtime loaders (for rsvg raster rendering)
HOMEBREW_CACHE="$AUTOBREW" $BREW reinstall gdk-pixbuf --without-modules --with-included-loaders=yes --build-bottle
HOMEBREW_CACHE="$AUTOBREW" $BREW install r-hub/cran/librsvg
HOMEBREW_CACHE="$AUTOBREW" $BREW install --force-bottle homebrew/core/librsvg
HOMEBREW_CACHE="$AUTOBREW" $BREW switch librsvg "2.40.19"
unset HOMEBREW_NO_ENV_FILTERING

# We use a custom bottle for Mavericks
if [ $(sw_vers -productVersion | grep -F "10.9") ]; then
  HOMEBREW_CACHE="$AUTOBREW" $BREW install --force-bottle imagemagick 2>&1 | perl -pe 's/Warning/Note/gi'
  $BREW link --force libffi gettext
else
  # Build IM6 from source
  HOMEBREW_CACHE="$AUTOBREW" $BREW install imagemagick@6 --build-bottle --without-modules --with-zero-configuration \
  --with-librsvg --with-pango --with-webp --with-fontconfig --with-openjpeg 2>&1 | perl -pe 's/Warning/Note/gi'
  $BREW link --force imagemagick@6 libffi gettext
fi

# Get the CFLAGS and LIBS
PKG_CONFIG="$BREWDIR/opt/pkg-config/bin/pkg-config"
PKG_CFLAGS=$($PKG_CONFIG --cflags $PKG_CONFIG_NAME)
PKG_CFLAGS="$PKG_CFLAGS -DBUILD_AUTOBREW"
PKG_LIBS=$($PKG_CONFIG --libs-only-l --static $PKG_CONFIG_NAME libpng libcroco-0.6 pangocairo gmodule-2.0 fribidi)
PKG_LIBS="-L$BREWDIR/lib $PKG_LIBS -lexpat" #pkg-config misses a few paths
rm -f $BREWDIR/Cellar/*/*/lib/*.dylib

# Prevent CRAN builder from linking against old libs in /usr/local/lib
for FILE in $BREWDIR/lib/*.a; do
  BASENAME=$(basename $FILE)
  LIBNAME=$(echo "${BASENAME%.*}" | cut -c4-)
  cp -f $FILE $BREWDIR/lib/libbrew$LIBNAME.a
  echo "created $BREWDIR/lib/libbrew$LIBNAME.a"
  PKG_LIBS=$(echo $PKG_LIBS | sed "s/-l$LIBNAME /-lbrew$LIBNAME /g")
done
rm -f $BREWDIR/lib/*.dylib

# Copy configuration files
mkdir -p inst/etc
cp -r $BREWDIR/etc/fonts inst/etc/

# Fix hardcoded cache dir
sed -i.bak "s#<cachedir>.*/var/cache/fontconfig#<cachedir>~/Library/Caches/magick#" inst/etc/fonts/fonts.conf
rm -f inst/etc/fonts/*.bak
